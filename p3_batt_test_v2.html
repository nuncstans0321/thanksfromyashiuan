<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>P3 Battery Test v2 — 不影響現有版</title>
<style>
:root{--hud-zoom:1.28;}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:#0e0f13;color:#111;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",Arial,sans-serif;display:flex;align-items:center;justify-content:center}
.stage{width:min(980px,96vw);height:min(780px,96svh)}@supports not (height:1svh){.stage{height:min(780px,96vh)}}
.card{position:relative;width:100%;height:100%;background:#f5f6f8;border-radius:22px;overflow:hidden;box-shadow:0 28px 60px rgba(0,0,0,.25),0 8px 18px rgba(0,0,0,.12),inset 0 0 0 1px rgba(0,0,0,.08)}
/* Banner + 4-grid */
.wrap{position:absolute;inset:0;padding:12px;display:grid;grid-template-rows:auto 1fr;gap:12px}
.banner{display:grid;justify-items:center;align-items:center;background:#fff7d9;border:1px solid #f2c94c;border-radius:12px;padding:10px 14px;font-weight:900;line-height:1.3}
.banner span{display:block}
.gridHold{position:relative}
.grid4{position:absolute;inset:0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:12px;z-index:1}
.badge{background:#fff;border:1px solid #0001;border-radius:14px;padding:8px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06);outline:0;display:grid;grid-template-rows:1fr;min-height:0}
.thumb{width:100%;height:100%;border-radius:10px;overflow:hidden;background:#fff;display:grid;place-items:center}
.thumb img{width:100%;height:100%;object-fit:contain;display:block}
/* Sheet */
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(105%);transition:transform .28s ease;z-index:120;display:grid;justify-items:center}
.sheet.show{transform:translateY(0)}
.sheet .scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);}
.sheet .panel{position:relative;width:min(720px,96vw);max-height:72svh;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -18px 48px rgba(0,0,0,.35);padding:16px 18px 18px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}
@media (min-width:720px){.sheet .panel{border-radius:18px;max-height:82svh;margin-bottom:4vh}}
.sheet h3{margin:0 0 6px 0;font-size:20px}
.sheet p{margin:0;color:#555}
.play{position:relative;background:#0f1220;border-radius:12px;display:grid;place-items:center;min-height:300px;overflow:hidden}
.play .bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.28;filter:blur(2px)}
.play .content{position:relative;padding:16px;color:#fff;display:grid;gap:16px;justify-items:center;z-index:4;text-shadow:0 1px 4px rgba(0,0,0,.45)}
/* Top hint bar — never overlaps center image */
.topHint{position:absolute;left:0;right:0;top:0;z-index:6;display:grid;justify-items:center;padding:8px 10px}
.topHint .hint{font-size:14px;background:linear-gradient(180deg,rgba(4,8,20,.76),rgba(4,8,20,.0));padding:6px 10px;border-radius:9px;color:#eaf7ff;writing-mode:horizontal-tb;white-space:normal;word-break:keep-all;text-align:center;max-width:min(560px,90%)}
/* Battery HUD */
.hud{position:absolute;inset:6% 4% 9% 4%;display:none;place-items:center;pointer-events:none;z-index:5;text-align:center;padding:10px}
.hud .wrap{width:100%;max-width:900px;display:grid;justify-items:center;gap:12px;transform:scale(var(--hud-zoom));transform-origin:center}
.hud img{width:auto;max-width:96%;max-height:90%;object-fit:contain;display:block;filter:drop-shadow(0 16px 36px rgba(0,0,0,.55))}
.battery{display:grid;gap:12px;justify-items:center;width:min(640px,96%);filter:drop-shadow(0 8px 20px rgba(0,0,0,.45))}
.b-cell{width:100%;aspect-ratio:2.4/1;border:6px solid #9bd2ff;border-radius:16px;position:relative;background:rgba(0,0,0,.3);overflow:hidden}
.b-cell:after{content:"";position:absolute;right:-18px;top:calc(50% - 18px);width:18px;height:36px;background:#9bd2ff;border-radius:4px}
.b-fill{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#1ee3ff,#7cffc9);box-shadow:inset 0 0 10px rgba(255,255,255,.35);transition:width .6s;border-right:4px solid rgba(255,255,255,.6)}
.b-label{font-weight:900;font-size:clamp(18px,3.6vw,28px);color:#d7f6ff;text-shadow:0 2px 6px rgba(0,0,0,.35)}
/* Close btn */
.actions{display:flex;justify-content:center}
.btn{border:1px solid #0002;background:#ffd24a;border-radius:999px;padding:.6rem 1.0rem;font-weight:800;cursor:pointer}
/* layout helper */
</style>
</head>
<body>
<div class="stage"><div class="card">
  <div class="wrap">
    <div class="banner"><span>亞璇的祝福派送中，</span><span>任選一份今日 Buff，點一下領取 ✨</span></div>
    <div class="gridHold"><div class="grid4" id="grid4">
      <div class="badge" id="b1"><div class="thumb"><img src="slot1.png" alt="能量瓶"></div></div>
      <div class="badge" id="b2"><div class="thumb"><img src="slot2.png" alt="花束"></div></div>
      <div class="badge" id="b3"><div class="thumb"><img src="slot3.png" alt="好天氣"></div></div>
      <div class="badge" id="b4"><div class="thumb"><img src="slot4.png" alt="禮物"></div></div>
    </div></div>
  </div>
</div></div>

<!-- Bottom Sheet -->
<div class="sheet" id="sheet"><div class="scrim"></div><div class="panel">
  <div><h3 id="sTitle"></h3><p id="sSub"></p></div>
  <div class="play">
    <div class="bg" id="sBg"></div>
    <div class="topHint"><div class="hint" id="topHint">提示列</div></div>
    <div class="content" id="sContent"></div>
  </div>
  <div class="actions"><button class="btn" id="sClose">✨ pika～ 關閉</button></div>
</div></div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const sheet=$("#sheet"), sBg=$("#sBg"), sTitle=$("#sTitle"), sSub=$("#sSub"), sContent=$("#sContent"), sClose=$("#sClose"), topHint=$("#topHint");

  // URL 控制放大倍率 ?zoom=1.32
  const zm=parseFloat(new URLSearchParams(location.search).get("zoom"));
  if(!Number.isNaN(zm)) document.documentElement.style.setProperty("--hud-zoom", String(zm));

  const on=(el,fn)=>["click","pointerup","touchend"].forEach(e=>el.addEventListener(e,(ev)=>{ev.preventDefault();ev.stopPropagation();fn();},{passive:false}));
  function openSheet({bg,title,sub,builder}){
    sBg.style.backgroundImage="url('"+bg+"')";
    sTitle.textContent=title; sSub.textContent=sub; sContent.innerHTML=""; topHint.textContent=""; sheet.classList.add("show"); builder(sContent);
  }
  function closeSheet(){ sheet.classList.remove("show"); }
  on(sClose, closeSheet); on(sheet.querySelector(".scrim"), closeSheet);

  // 檢查 B.png 是否存在
  const B = { ok:false };
  (function(){ const img=new Image(); img.onload=()=>B.ok=true; img.onerror=()=>B.ok=false; img.src="B.png"; })();

  // Battery builder（文字不再覆蓋中央圖；滿格圖會一直顯示到關閉）
  function buildBattery(box){
    const hud=document.createElement("div"); hud.className="hud"; const wrap=document.createElement("div"); wrap.className="wrap"; hud.appendChild(wrap);
    // 置中進度條（第一下使用）
    const bar=document.createElement("div");
    bar.style.cssText="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(520px,80%);height:26px;border-radius:14px;background:rgba(255,255,255,.15);box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)";
    const fill=document.createElement("div");
    fill.style.cssText="height:100%;width:0;background:linear-gradient(90deg,#23e1ff,#79ffc6);border-radius:14px;transition:width .8s ease";
    bar.appendChild(fill);
    box.append(hud,bar);

    let step=0, done=false, lock=false;
    const showHUD=(percent,useImage)=>{
      wrap.innerHTML="";
      if(useImage){ const im=document.createElement("img"); im.alt="滿格"; im.src="B.png"; wrap.appendChild(im); }
      else{
        const bat=document.createElement("div"); bat.className="battery";
        const cell=document.createElement("div"); cell.className="b-cell";
        const lvl=document.createElement("div"); lvl.className="b-fill"; lvl.style.width=percent+"%";
        const lab=document.createElement("div"); lab.className="b-label"; lab.textContent="⚡️ "+percent+"%";
        cell.appendChild(lvl); bat.append(cell,lab); wrap.appendChild(bat);
      }
      hud.style.display="grid";
    };
    const reset=()=>{step=0;done=false;lock=false;hud.style.display="none";fill.style.width="0";bar.style.display="block";topHint.textContent="輕點畫面充電 →";};

    on(box, ()=>{
      if(lock||done) return; lock=true;
      step=(step%3)+1;
      if(step===1){
        topHint.textContent="再點：80%";
        bar.style.display="block";
        requestAnimationFrame(()=>fill.style.width="100%");
        setTimeout(()=>{ fill.style.width="0"; lock=false; }, 900);
      }else if(step===2){
        topHint.textContent="最後一下：滿格！";
        bar.style.display="none";
        showHUD(80,false);
        setTimeout(()=>{lock=false;}, 280);
      }else{
        showHUD(100, B.ok);
        topHint.textContent="滿格！關閉後可再玩一次，或換其他 Buff。";
        done=true; lock=false;
      }
    });
    on(sClose, reset); on(sheet.querySelector(".scrim"), reset);
    // 初始提示
    topHint.textContent="輕點畫面充電 →";
  }

  on(document.getElementById("b1"), ()=>openSheet({
    bg:"slot1.png", title:"今天電量不足？充電站啟動 ⚡️", sub:"提示：每一下都有變化，第三下有小彩蛋！", builder:buildBattery
  }));

  // 讓四格完整可見（與你的正式版一致邏輯）
  function layoutP3(){ const wrap=document.querySelector(".wrap"); const banner=wrap.querySelector(".banner"); const hold=wrap.querySelector(".gridHold"); const grid=wrap.querySelector(".grid4");
    const gap=parseFloat(getComputedStyle(grid).gap)||12, reserved=16, availH=wrap.clientHeight-banner.offsetHeight-gap-reserved, availW=hold.clientWidth;
    const w=Math.floor((availW-gap)/2), hcap=Math.floor((availH-gap)/2), tile=Math.max(120,Math.min(w,hcap)); hold.style.height=(tile*2+gap)+"px"; grid.querySelectorAll(".badge").forEach(el=>el.style.height=tile+"px"); }
  addEventListener("resize", layoutP3); setTimeout(layoutP3,60);
})();
</script>
</body>
</html>
