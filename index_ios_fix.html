<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>v9.4.iOS-P3 ‰øÆÊ≠£Áâà</title>
<style>
:root{--r:22px;--gap:12px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",Arial,sans-serif;background:#0e0e10;color:#1f2328;display:flex;align-items:center;justify-content:center;overflow:hidden}
.stage{width:min(980px,96vw);height:min(780px,96svh)}@supports not (height:1svh){.stage{height:min(780px,96vh)}}
.card{position:relative;width:100%;height:100%;background:#f2f3f5;border-radius:var(--r);overflow:hidden;box-shadow:0 28px 60px rgba(0,0,0,.25),0 8px 18px rgba(0,0,0,.12),inset 0 0 0 1px rgba(0,0,0,.08)}
.page{position:absolute;inset:0;padding:20px;display:grid;place-items:center;opacity:0;transform:translateY(8px);transition:.3s}
.page.active{opacity:1;transform:none}
#p1,#p2,#p4{padding:0}
#p3{display:block;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px}
.vbox{position:relative;width:100%;height:100%;background:#000;border-radius:var(--r);overflow:hidden;display:flex;align-items:center;justify-content:center}
.vbox video{width:100%;height:100%;object-fit:contain;background:#000;display:block}
/* ‰∏ã‰∏ÄÈ†Å */
.next{position:fixed;right:calc(2vw + 8px);bottom:calc(2vh + 8px);padding:.7rem 1.05rem;border-radius:999px;border:1px solid #0002;background:#ffd24a;font-weight:800;z-index:60;display:none}
.next.show{display:inline-block}
/* p2 Ê©´ÂπÖ */
.p2ribbon{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#fff;border:1px solid #f2c94c;border-radius:12px;padding:6px 10px;font-weight:800;z-index:2;white-space:nowrap;max-width:95%;overflow:hidden;text-overflow:ellipsis;font-size:18px}
@media (max-width:480px){.p2ribbon{font-size:16px}}
/* p3 */
.gridArea{height:100%;display:grid;grid-template-rows:auto 1fr;gap:var(--gap)}
.banner{display:grid;grid-auto-rows:auto;justify-items:center;align-items:center;background:#fff7d9;border:1px solid #f2c94c;border-radius:12px;padding:10px 14px;font-weight:900;line-height:1.35}
.banner span{display:block}
.gridHold{position:relative}
.grid4{position:absolute;inset:0;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:var(--gap);z-index:1}
.badge{background:#fff;border:1px solid #0001;border-radius:14px;padding:8px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.06);outline:0;display:grid;grid-template-rows:1fr;min-height:0;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.badge:focus{box-shadow:0 0 0 3px #3b82f6aa}
.thumb{width:100%;height:100%;border-radius:10px;overflow:hidden;background:#fff;display:grid;place-items:center}
.thumb img{width:100%;height:100%;object-fit:contain;display:block}
/* SheetÔºàÈóúÈñâÊôÇ‰∏çÂêÉ‰∫ã‰ª∂Ôºâ */
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(105%);transition:transform .28s ease;z-index:120;display:grid;justify-items:center;pointer-events:none;visibility:hidden}
.sheet.show{transform:translateY(0);pointer-events:auto;visibility:visible}
.sheet .scrim{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
.sheet .panel{position:relative;width:min(720px,96vw);max-height:72svh;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -18px 48px rgba(0,0,0,.35);padding:16px 18px 18px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}
@media (min-width:720px){.sheet .panel{border-radius:18px;max-height:82svh;margin-bottom:4vh}}
.sheet h3{margin:0 0 6px 0;font-size:20px}
.sheet p{margin:0;color:#555}
.play{position:relative;background:#0f1220;border-radius:12px;display:grid;place-items:center;min-height:280px;overflow:hidden}
.play .bg{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.28;filter:blur(2px)}
.play .content{position:relative;padding:16px;color:#fff;display:grid;gap:16px;justify-items:center;z-index:4;text-shadow:0 1px 4px rgba(0,0,0,.45)}
.hint{font-size:12px;opacity:.95;text-align:center}
.sheet .actions{display:flex;justify-content:center}
.sheet .btn{border:1px solid #0002;background:#ffd24a;border-radius:999px;padding:.6rem 1.0rem;font-weight:800;cursor:pointer}
/* Â∞èÂÖÉ‰ª∂ */
.pbar{width:min(520px,80%);height:12px;border:1px solid #2f3a5d;background:#0f1220;border-radius:999px;overflow:hidden}
.fill{width:0;height:100%;background:linear-gradient(90deg,#5146ff,#ffd54a);transition:width 1.0s}
.face{font-size:60px}
.stamp{margin-top:6px;border:2px dashed #7ec3ff;color:#7ec3ff;font-weight:800;border-radius:8px;padding:4px 8px;opacity:0;transform:scale(.9);transition:.3s}
.shield{background:#24352a;color:#bff5cf;border:1px solid #3e6b4f;border-radius:10px;padding:6px 10px;opacity:0;transform:translateY(6px);transition:.3s}
/* Battery HUD */
.hud{position:absolute;inset:4% 2% 16% 2%;display:none;place-items:center;pointer-events:none;z-index:3;text-align:center;padding:10px}
.hud .wrap{width:100%;display:grid;justify-items:center;gap:10px}
.hud img{max-width:100%;max-height:70%;object-fit:contain;display:block;filter:drop-shadow(0 12px 28px rgba(0,0,0,.55))}
.b-label{font-weight:900;font-size:clamp(18px,3vw,28px);color:#d7f6ff;text-shadow:0 2px 6px rgba(0,0,0,.35)}
/* Á¶ÆÁâ© */
.giftWrap{position:relative;display:grid;place-items:center;padding-top:64px}
.giftImg{width:min(380px,82%);max-width:82%;height:auto;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
.giftGlow{animation:glow 1s ease-out}
@keyframes glow{0%{filter:brightness(1)}50%{filter:brightness(1.35)}100%{filter:brightness(1)}}
.giftNote{position:absolute;left:50%;top:10px;transform:translateX(-50%);background:#fff;color:#333;padding:6px 10px;border-radius:8px;font-size:12px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.35);opacity:0;transition:.25s;z-index:3}
/* ÁµêÂ∞æ */
.finalOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(62% 60% at 50% 58%, rgba(0,0,0,.55), rgba(0,0,0,.15));backdrop-filter:blur(1.5px);z-index:70}
.finalOverlay.show{display:flex}
.finalWrap{display:grid;gap:14px;justify-items:center;text-align:center;padding:12px 16px}
.finalWrap .jp{color:#fff;font-weight:900;font-size:clamp(22px,6vw,44px);text-shadow:0 3px 18px rgba(0,0,0,.6),0 1px 0 rgba(0,0,0,.25)}
.finalBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.finalBtns .btn{border:1px solid #0002;background:rgba(255,210,74,.96);border-radius:999px;padding:.6rem 1.0rem;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,.25);cursor:pointer}
.finalBtns .ghost{background:rgba(255,255,255,.92)}
/* Á≤íÂ≠ê */
.petal,.ray,.confetti,.sparkle{position:absolute;pointer-events:none;opacity:0;animation-fill-mode:forwards}
@keyframes petalFall{0%{transform:translateY(-10px) rotate(0);opacity:0}10%{opacity:1}100%{transform:translateY(120px) rotate(260deg);opacity:0}}
@keyframes sunRay{from{transform:rotate(var(--r)) translateY(0);opacity:.9}to{transform:rotate(calc(var(--r) + 20deg)) translateY(-8px);opacity:0}}
@keyframes conf{from{transform:translateY(0) rotate(0);opacity:1}to{transform:translateY(-26px) rotate(90deg);opacity:0}}
@keyframes sp{from{transform:translateY(0) scale(.9);opacity:0}10%{opacity:1}to{transform:translateY(-18px) scale(1.1);opacity:0}}
/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#1e2433;border:1px solid #334063;color:#e8ebff;padding:8px 12px;border-radius:10px;opacity:0;transition:.25s;pointer-events:none;z-index:140}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
</style>
</head>
<body>
<div class="stage"><div class="card">
  <!-- P1 -->
  <section class="page active" id="p1">
    <div class="vbox"><video id="vIntro" playsinline webkit-playsinline muted preload="auto"><source id="sIntro" src="envelope_open.mp4" type="video/mp4"></video></div>
    <button class="next" id="n1">‰∏ã‰∏ÄÈ†Å</button>
  </section>
  <!-- P2 -->
  <section class="page" id="p2">
    <div class="vbox">
      <div class="p2ribbon" id="ribbon">Áµ¶ÂçöÁöìÂ≠∏Èï∑ ÔΩû by 62 ÊúüÂ≠∏Âì°‰∫ûÁíá</div>
      <video id="vAscii" playsinline webkit-playsinline muted preload="auto" loop><source id="sAscii" src="ascii_anim.mp4" type="video/mp4"></video>
    </div>
    <button class="next show" id="n2">‰∏ã‰∏ÄÈ†Å</button>
  </section>
  <!-- P3 -->
  <section class="page" id="p3">
    <div class="gridArea">
      <div class="banner">
        <span>‰∫ûÁíáÁöÑÁ•ùÁ¶èÊ¥æÈÄÅ‰∏≠Ôºå</span>
        <span>‰ªªÈÅ∏‰∏Ä‰ªΩ‰ªäÊó• BuffÔºåÈªû‰∏Ä‰∏ãÈ†òÂèñ ‚ú®</span>
      </div>
      <div class="gridHold"><div class="grid4" id="grid4">
        <div class="badge" id="b1" role="button" tabindex="0"><div class="thumb"><img src="slot1.png" alt="ËÉΩÈáèÁì∂"></div></div>
        <div class="badge" id="b2" role="button" tabindex="0"><div class="thumb"><img src="slot2.png" alt="Ëä±Êùü"></div></div>
        <div class="badge" id="b3" role="button" tabindex="0"><div class="thumb"><img src="slot3.png" alt="Â•ΩÂ§©Ê∞£"></div></div>
        <div class="badge" id="b4" role="button" tabindex="0"><div class="thumb"><img src="slot4.png" alt="Á¶ÆÁâ©"></div></div>
      </div></div>
    </div>
    <button class="next show" id="n3">‰∏ã‰∏ÄÈ†Å</button>
  </section>
  <!-- P4 -->
  <section class="page" id="p4">
    <div class="vbox" id="finalBox">
      <video id="vFinale" playsinline webkit-playsinline muted preload="auto"><source id="sFinale" src="finale.mp4" type="video/mp4"></video>
      <div class="finalOverlay" id="finalOverlay">
        <div class="finalWrap">
          <div class="jp">„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇ</div>
          <div class="finalBtns">
            <button class="btn" id="btnReplay">‚ü≤ ÈáçÈ†≠ÈñãÂßã</button>
            <button class="btn ghost" id="btnCopy">üîó Ë§áË£ΩÈÄ£Áµê</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div></div>

<!-- Bottom Sheet -->
<div class="sheet" id="sheet">
  <div class="scrim"></div>
  <div class="panel">
    <div><h3 id="sTitle"></h3><p id="sSub"></p></div>
    <div class="play" id="playStage">
      <div class="bg" id="sBg"></div>
      <div class="content" id="sContent"></div>
    </div>
    <div class="actions"><button class="btn" id="sClose">‚ú® pikaÔΩû ÈóúÈñâ</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const t=$("#toast");
  const bust=Date.now().toString(36);

  // bust cache for sources & images
  ["#sIntro","#sAscii","#sFinale"].forEach(sel=>{
    const el=$(sel); if(el){ el.src = el.getAttribute("src")+"?v="+bust; }
  });
  document.querySelectorAll("img").forEach(img=>{
    const src=img.getAttribute("src"); if(src) img.setAttribute("src", src+(src.includes("?")?"&":"?")+"v="+bust);
  });

  // Page nav
  const pages=[...document.querySelectorAll(".page")]; let idx=0;
  const show=n=>{ pages[idx].classList.remove("active"); idx=Math.max(0,Math.min(pages.length-1,n)); pages[idx].classList.add("active"); };
  const v1=$("#vIntro"), v2=$("#vAscii"), v3=$("#vFinale");
  const n1=$("#n1"), n2=$("#n2"), n3=$("#n3");

  // P1ÔºöÊí≠ÊîæÂÆåÊâçÈ°ØÁ§∫‰∏ã‰∏ÄÈ†Å
  v1.play().catch(()=>{ v1.setAttribute("controls",""); });
  v1.addEventListener("ended", ()=> n1.classList.add("show"));
  bindTap(n1, ()=>{ show(1); v2.play().catch(()=> v2.setAttribute("controls","")); });

  bindTap(n2, ()=> show(2));
  bindTap(n3, ()=>{ show(3); v3.play().catch(()=> v3.setAttribute("controls","")); });

  // Bottom Sheet controller
  const sheet=$("#sheet"), sBg=$("#sBg"), sTitle=$("#sTitle"), sSub=$("#sSub"), sContent=$("#sContent"), sClose=$("#sClose");
  function openSheet({bg, title, titleHTML, sub, builder}){
    sBg.style.backgroundImage="url('"+bg+"?v="+bust+"')";
    if(titleHTML){ sTitle.innerHTML=titleHTML; } else { sTitle.textContent=title; }
    sSub.textContent=sub || "";
    sContent.innerHTML="";
    builder(sContent, setStageTap);
    sheet.classList.add("show");
  }
  function closeSheet(){ sheet.classList.remove("show"); }
  bindTap(sClose, closeSheet);
  bindTap(sheet.querySelector(".scrim"), closeSheet);

  // ËàûÂè∞Áµ±‰∏Ä tapÔºàiPhone ÂÆâÂÖ®Ôºâ
  function setStageTap(handler){
    const old = document.getElementById("playStage");
    const fresh = old.cloneNode(true);
    old.parentNode.replaceChild(fresh, old);
    bindTap(fresh, (e)=> handler(e, fresh));
  }

  // ÂÆâÂÖ® tap Á∂ÅÂÆöÔºàpointerup ÂñÆÈÄöÈÅì + ÂéªÈáçÔºâ
  let lastTap = 0;
  function bindTap(el, fn){
    if(!el) return;
    el.style.touchAction = "manipulation";
    el.addEventListener("pointerup", (e)=>{
      if(e.pointerType==="mouse" && e.button!==0) return;
      const now=Date.now(); if(now-lastTap<180) return; lastTap=now;
      e.preventDefault(); e.stopPropagation(); fn(e);
    }, {passive:false});
  }

  function burst(el,n=10){
    const r = el.getBoundingClientRect();
    for(let i=0;i<n;i++){
      const s=document.createElement("div");
      s.className="sparkle"; s.textContent=Math.random()>0.5?"‚ú®":"‚ö°Ô∏è";
      s.style.position="fixed";
      s.style.left=(r.left+r.width/2+(Math.random()*60-30))+"px";
      s.style.top=(r.top+r.height/2+(Math.random()*30-15))+"px";
      s.style.animation="sp .8s ease-out forwards";
      s.style.opacity=0; document.body.appendChild(s);
      setTimeout(()=>s.remove(),850);
    }
  }

  // P3 tiles -> open sheets
  const tiles = [
    {sel:"#b1", bg:"slot1.png", type:"energy"},
    {sel:"#b2", bg:"slot2.png", type:"flower"},
    {sel:"#b3", bg:"slot3.png", type:"weather"},
    {sel:"#b4", bg:"slot4.png", type:"gift"}
  ];

  tiles.forEach(({sel,bg,type})=>{
    const tile = document.querySelector(sel);
    const img = tile && tile.querySelector("img");
    const open = ()=>{
      if(type==="energy"){ // ÂÖÖÈõªÔºöÊ¢ù‚Üí80%‚Üí100%Ôºà100%Â∏∏ÈßêÔºâ
        openSheet({
          bg, title:"‰ªäÂ§©ÈõªÈáè‰∏çË∂≥ÔºüÂÖÖÈõªÁ´ôÂïüÂãï ‚ö°Ô∏è", sub:"Â§öÊåâÂπæ‰∏ãÁúãÁúãÔºÅ",
          builder:(box, attach)=>{
            const tip=el("div","hint","ËºïÈªûÁï´Èù¢ÂÖÖÈõª ‚Üí");
            const pbar=el("div","pbar"); const fill=el("div","fill"); pbar.appendChild(fill);
            const hud=el("div","hud"); const wrap=el("div","wrap"); hud.appendChild(wrap);
            box.append(tip,pbar,hud);
            let step=0, hudTimer=null;
            const showHUD=(persist=false, ms=1800)=>{
              if(hudTimer){ clearTimeout(hudTimer); hudTimer=null; }
              hud.style.display="grid";
              if(!persist) hudTimer=setTimeout(()=>{ hud.style.display="none"; hudTimer=null; }, ms);
            };
            const renderBattery=(percent, useImg=false)=>{
              wrap.innerHTML="";
              if(useImg){ const im=new Image(); im.src="B.png?v="+bust; im.alt="battery"; im.style.maxWidth="100%"; wrap.appendChild(im); }
              wrap.appendChild(el("div","b-label","‚ö°Ô∏è "+percent+"%"));
            };
            attach(()=>{
              step=(step%3)+1;
              if(step===1){
                requestAnimationFrame(()=> fill.style.width="100%");
                tip.textContent="ÂÜçÈªûÔºö80%";
                setTimeout(()=> fill.style.width="0", 900);
              }else if(step===2){
                renderBattery(80,false); showHUD(false,2300); tip.textContent="ÊúÄÂæå‰∏Ä‰∏ãÔºöÊªøÊ†ºÔºÅ";
              }else{
                renderBattery(100,true); showHUD(true); burst(box,14);
                tip.textContent="ÊªøÊ†ºÔºÅpikaÔΩûÈóúÈñâÂæåÂèØÂÜçÁé©ÔºåÊàñÊèõÂÖ∂‰ªñ Buff„ÄÇ";
              }
            });
          }
        });
      }else if(type==="flower"){ // Ëä±ÊùüÔºö‰∏âÊÆµÂçáÁ¥ö + ÁõæÁâå
        openSheet({
          bg, title:"ÈÄÅ‰Ω†‰∏ÄÊùü‰ªäÊó•ÁöÑÂ•ΩÈÅã üíê", sub:"Â§öÈªûÂπæ‰∏ãÔºåÂ•ΩÈÅãÈÄ£ÈÄ£„ÄÇ",
          builder:(box, attach)=>{
            const tip=el("div","hint","ËºïÈªûÁúãÁúã ‚Üí");
            const face=el("div","face","üå∏");
            const shield=el("div","shield","üçÄ ÊäµÁ¶¶Á™ÅÁôº");
            const halo=el("div"); halo.style.cssText="position:absolute;inset:0;margin:auto;width:min(520px,80%);max-height:72%;aspect-ratio:1/1;border-radius:50%;background:radial-gradient(circle, rgba(255,235,130,.8), rgba(255,235,130,.06) 60%, transparent 70%);filter:blur(2px);opacity:0;transition:.35s";
            box.append(tip,face,shield,halo);
            const petals=(n=10)=>{for(let i=0;i<n;i++){const p=el("div","petal","üå∏"); p.style.left=(Math.random()*70+15)+'%'; p.style.top='-8px'; p.style.position="absolute"; p.style.fontSize=(Math.random()*12+16)+'px'; p.style.animation="petalFall 1.3s ease-in forwards"; p.style.opacity=1; box.appendChild(p); setTimeout(()=>p.remove(),1500);}};
            const glitter=()=>{for(let i=0;i<12;i++){const s=el("div","sparkle","‚ú®"); s.style.position="absolute"; s.style.left=(Math.random()*70+15)+'%'; s.style.top=(Math.random()*40+30)+'%'; s.style.animation="sp .9s ease-out forwards"; s.style.opacity=1; box.appendChild(s); setTimeout(()=>s.remove(),950);}};
            let step=0;
            attach(()=>{
              step=(step%3)+1;
              if(step===1){ face.textContent="üíê"; petals(8); tip.textContent="ÂÜçÈªûÈªûÁúã"; burst(box,6); }
              else if(step===2){ face.textContent="üåº"; petals(16); tip.textContent="ÂÜçÈªûÈªûÁúã"; burst(box,6); }
              else{ face.textContent="üåü"; halo.style.opacity=1; shield.style.opacity=1; shield.style.transform="translateY(0)"; glitter(); burst(box,10);
                setTimeout(()=>{ shield.style.opacity=0; halo.style.opacity=0; }, 1400);
                tip.textContent="ÂÆåÊàêÔºÅ";
              }
            });
          }
        });
      }else if(type==="weather"){ // Â§©Ê∞£ÔºöÈô∞‚ÜíÊô¥‚ÜíÂΩ©Ëôπ + Á´†
        openSheet({
          bg, titleHTML:'Â§©Ê∞£Á≥ªÁµ±ÈÄ£Á∑ö‰∏≠‚Ä¶<br>‰ªäÊó•Êô¥ÊúóÊåáÊï∏ÊèêÂçáÔºåÂøÉÊÉÖÊîæÊô¥ÔºÅ üåà', sub:"‰∏çË´ñÊô¥Èõ®ÔºåÈ°ò‰Ω†ËôïËôïÈ†ÜÂøÉ„ÄÇ",
          builder:(box, attach)=>{
            const tip=el("div","hint","ËºïÈªûÁúãÁúã‚Üí");
            const face=el("div","face","üå•Ô∏è");
            const stamp=el("div","stamp","+1 È†ÜÂà©");
            box.append(tip,face,stamp);
            const rays=()=>{for(let i=0;i<6;i++){const r=el("div","ray","‚ú¥Ô∏é"); r.style.position="absolute"; r.style.left=(50 + Math.cos(i)*22)+'%'; r.style.top=(48 + Math.sin(i)*18)+'%'; r.style.setProperty('--r',(i*60)+'deg'); r.style.animation="sunRay .8s ease-out forwards"; r.style.opacity=1; box.appendChild(r); setTimeout(()=>r.remove(),900);}};
            const confetti=()=>{const colors=['#f66','#fd6','#6f6','#6df','#86f']; for(let i=0;i<12;i++){const c=el("div","confetti",""); c.style.position="absolute"; c.style.width='6px'; c.style.height='6px'; c.style.borderRadius='2px'; c.style.background=colors[i%colors.length]; c.style.left=(Math.random()*80+10)+'%'; c.style.top=(Math.random()*20+20)+'%'; c.style.animation='conf .7s ease-out forwards'; c.style.opacity=1; box.appendChild(c); setTimeout(()=>c.remove(),800);}};
            let s=0;
            attach(()=>{
              s=(s%3)+1;
              if(s===1){ face.textContent="‚õÖ"; tip.textContent="ÂÜçÈªûÈªûÁúã"; }
              else if(s===2){ face.textContent="‚òÄÔ∏è"; tip.textContent="ÂÜçÈªûÈªûÁúã"; rays(); }
              else{ face.textContent="üåà"; tip.textContent="ÊîæÊô¥ÂÆåÊàêÔºÅ"; stamp.style.opacity=1; stamp.style.transform="scale(1)"; confetti(); setTimeout(()=>{ stamp.style.opacity=0; stamp.style.transform="scale(.9)"; }, 1100); burst(box,8); }
            });
          }
        });
      }else{ // Á¶ÆÁâ©
        openSheet({
          bg, title:"ÈÄô‰ªΩÂ∞èÁ¶ÆÁâ©ÔºåË£ùËëóËê¨ÂàÜÊÑüË¨ù ‚ú®‚ù§Ô∏è", sub:"Â§öÈªû‰∏Ä‰∏ãÊãÜÈñãÁ¶ÆÁõíÔΩû",
          builder:(box, attach)=>{
            const tip=el("div","hint","ËºïÈªûÈñãÁõí ‚Üí");
            const wrap=el("div","giftWrap","");
            const img=new Image(); img.className="giftImg"; img.src="slot4.png?v="+bust; img.alt="Á¶ÆÁâ©";
            const note=el("div","giftNote","ÂçöÁöìÂ≠∏Èï∑ÔºåË¨ùË¨ù‰Ω†ÔºåËæõËã¶‰∫ÜÔºàfighting!Ôºâ");
            note.style.whiteSpace="pre-wrap"; note.style.textAlign="center";
            wrap.append(img,note); box.append(tip,wrap);
            let step=0, showing=false;
            attach(()=>{
              step=(step%2)+1;
              if(step===1){ img.classList.remove("giftGlow"); void img.offsetWidth; img.classList.add("giftGlow"); burst(wrap,10); tip.textContent="ÂÜçÈªû‰∏ÄÊ¨°ÔºåÂëà‰∏äÂ§ßÊÑüË¨ùÔºÅ"; }
              else{ if(!showing){ showing=true; note.style.opacity=1; tip.textContent="ÂÆåÊàêÔºÅ"; setTimeout(()=>{ note.style.opacity=0; showing=false; }, 2600); } }
            });
          }
        });
      }
    };
    bindTap(tile, open);
    if(img) bindTap(img, open);
  });

  // P3 Ëá™ÈÅ©ÊáâÈ´òÂ∫¶ÔºåÁ¢∫‰øùÂõõÊ†ºÂÆåÊï¥È°ØÁ§∫
  function layoutP3(){
    const p3=$("#p3"), banner=p3.querySelector(".banner"), hold=p3.querySelector(".gridHold"), grid=p3.querySelector(".grid4");
    const gap=parseFloat(getComputedStyle(grid).gap)||12, reserved=90;
    const availH = p3.clientHeight - banner.offsetHeight - gap - reserved, availW = hold.clientWidth;
    const tileW = Math.floor((availW - gap)/2), tileHcap = Math.floor((availH - gap)/2), tile = Math.max(120, Math.min(tileW, tileHcap));
    hold.style.height = (tile*2 + gap) + "px"; grid.querySelectorAll(".badge").forEach(el=>el.style.height = tile+"px");
  }
  addEventListener("resize", layoutP3); setTimeout(layoutP3, 60);

  // P4 ÁµêÂ∞æ
  const overlay=$("#finalOverlay"), btnReplay=$("#btnReplay"), btnCopy=$("#btnCopy");
  v3.addEventListener("ended", ()=> overlay.classList.add("show"));
  bindTap(btnReplay, ()=>{ overlay.classList.remove("show"); show(0); $("#n1").classList.remove("show"); v1.currentTime=0; v1.play().catch(()=> v1.setAttribute("controls","")); });
  bindTap(btnCopy, async ()=>{
    try{ await navigator.clipboard.writeText(location.href); toast("Â∑≤Ë§áË£ΩÈÄ£Áµê"); }
    catch{ toast("ÁÑ°Ê≥ïË§áË£ΩÔºåË´ãÊâãÂãïÈÅ∏ÂèñÁ∂≤ÂùÄ"); }
  });

  function toast(msg){ t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1300); }
  function el(tag, cls, text){ const x=document.createElement(tag); if(cls) x.className=cls; if(text!==undefined) x.textContent=text; return x; }
})();
</script>
</body>
</html>
