<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ„Ÿè¬å¡ â€” Play Button Flow</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{ --bg:#fff8ec; --paper:#fffef9; --ink:#222; --gold:#ffd24d; --radius:22px; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:ui-rounded,"Noto Sans TC",system-ui,-apple-system,Segoe UI,Arial;
     background:radial-gradient(1200px 800px at 20% 20%,#fffaf0,var(--bg));
     color:var(--ink);display:flex;align-items:center;justify-content:center;overflow:hidden}
.stage{width:min(980px,96vw);height:min(700px,94svh);position:relative}
@supports not (height:1svh){.stage{height:min(700px,94vh)}}
.card{position:absolute;inset:0;background:var(--paper);border-radius:var(--radius);
      box-shadow:0 20px 60px rgba(0,0,0,.14),0 6px 18px rgba(0,0,0,.07);overflow:hidden;
      display:grid;grid-template-rows:1fr auto}
.pages{position:relative;overflow:hidden}
.page{position:absolute;inset:0;opacity:0;transform:translateY(10px) scale(.98);
      transition:.45s ease;padding:clamp(12px,3vw,28px);display:grid;place-items:center}
.page.active{opacity:1;transform:none}

/* video area */
.vbox{position:relative;width:100%;height:100%;display:grid;place-items:center;background:#fff;border-radius:16px;overflow:hidden}
.vbox video{width:100%;height:100%;object-fit:contain;background:transparent;display:block}
.playBtn{position:absolute;right:14px;bottom:14px;z-index:6;border:none;border-radius:14px;
         background:#111;color:#fff;padding:.7rem 1rem;font-weight:800;
         box-shadow:0 10px 24px rgba(0,0,0,.25);cursor:pointer;display:flex;align-items:center;gap:.45rem}
.playBtn .tri{display:inline-block;width:0;height:0;border-left:10px solid #fff;border-top:7px solid transparent;border-bottom:7px solid transparent}
.playBtn.hide{display:none}

/* ascii */
.p2wrap{position:relative;width:100%;height:100%;background:#111;border-radius:16px;display:grid;place-items:center}
.p2wrap video{width:100%;height:100%;object-fit:contain;background:transparent}

/* grid 4 */
.grid4{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:14px;width:100%;height:100%}
.badge{display:grid;place-items:center;border:1px solid #f0e6c6;border-radius:16px;background:#fffdf3;text-decoration:none;color:inherit;min-height:180px}
.badge img{width:min(42vw,200px);height:min(42vw,200px);object-fit:contain}

/* nav */
.nav{display:flex;gap:10px;justify-content:flex-end;padding:10px}
button.btn{appearance:none;border:none;padding:.8rem 1.1rem;border-radius:12px;background:#111;color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.12)}
button.btn.alt{background:var(--gold);color:#3b2a00}
button.btn[disabled]{opacity:.5;pointer-events:none}

/* popups */
.layer{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;place-items:center;z-index:50}
.layer:target{display:grid}
.layer .box{background:#fff;color:#222;padding:22px;border-radius:16px;width:min(92vw,720px);text-align:center;font-size:clamp(18px,4vw,24px);line-height:1.6;box-shadow:0 16px 44px rgba(0,0,0,.28)}
.layer .ok{display:inline-block;margin-top:14px;background:#111;color:#fff;padding:.7rem 1.1rem;border-radius:12px;text-decoration:none;font-weight:800}
.layer .bgclose{position:absolute;inset:0;content:"";display:block}

/* finale overlay */
.final-msg{position:absolute;inset:0;display:none;place-items:center;background:rgba(255,255,255,.0)}
.final-msg .inner{text-align:center}
.final-msg .jp{font-weight:900;letter-spacing:.04em;font-size:clamp(28px,5vw,72px)}
.final-msg .jp small{display:block;font-size:.45em;opacity:.75;margin-top:.2em}
.final-msg .btns{margin-top:16px;display:flex;gap:10px;justify-content:center}
.shareLayer{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:60}
.shareLayer.show{display:grid}
.shareCard{background:#fff;padding:20px;border-radius:16px;width:min(92vw,420px);box-shadow:0 16px 44px rgba(0,0,0,.33);text-align:center}
.shareCard .qr{display:grid;place-items:center;margin:10px auto}
.shareCard .row{display:flex;gap:8px;justify-content:center;margin-top:8px}
.copyNote{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>
<div class="stage">
  <div class="card">
    <div class="pages">
      <!-- p1 -->
      <section class="page active" id="p1">
        <div class="vbox" id="p1box">
          <video id="vIntro" playsinline webkit-playsinline preload="auto" muted poster="poster.png" src="envelope_open.mp4"></video>
          <button class="playBtn" id="playIntro" aria-label="é»ä¿¡å°æ’­æ”¾"><span class="tri"></span>æ’­æ”¾</button>
        </div>
      </section>
      <!-- p2 -->
      <section class="page" id="p2">
        <div class="p2wrap" id="p2wrap">
          <video id="vAscii" playsinline webkit-playsinline preload="auto" muted loop src="ascii_anim.mp4"></video>
        </div>
      </section>
      <!-- p3 -->
      <section class="page" id="p3">
        <div class="grid4">
          <a class="badge" href="#pop1"><img id="slot1" src="slot1.png" alt="èƒ½é‡ç“¶"></a>
          <a class="badge" href="#pop2"><img id="slot2" src="slot2.png" alt="å¥½å¤©æ°£"></a>
          <a class="badge" href="#pop3"><img id="slot3" src="slot3.png" alt="èŠ±æŸ"></a>
          <a class="badge" href="#pop4"><img id="slot4" src="slot4.png" alt="ç¦®ç‰©"></a>
        </div>
      </section>
      <!-- p4 -->
      <section class="page" id="p4">
        <div class="vbox" id="p4box">
          <video id="vFinale" playsinline webkit-playsinline preload="auto" muted src="finale.mp4"></video>
          <div class="final-msg" id="finalMsg">
            <div class="inner">
              <div class="jp">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™<small>ã„ã¤ã‚‚å¿œæ´ã—ã¦ãã‚Œã¦ã€ã»ã‚“ã¨ã†ã«æ„Ÿè¬ã§ã™ã€‚</small></div>
              <div class="btns">
                <button class="btn alt" id="btnReplay">å†ä¸€æ¬¡</button>
                <button class="btn" id="btnShare">åˆ†äº«</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="nav">
      <button class="btn" id="btnPrev" disabled>ä¸Šä¸€é </button>
      <button class="btn alt" id="btnNext" disabled>ä¸‹ä¸€é </button>
    </div>
  </div>
</div>

<!-- popups -->
<section id="pop1" class="layer"><a href="#p3" class="bgclose"></a><div class="box">å·¥ä½œè¾›è‹¦äº†ï¼ŒåŠ æ²¹ ğŸ’ªâœ¨<br><a class="ok" href="#p3">pika~</a></div></section>
<section id="pop2" class="layer"><a href="#p3" class="bgclose"></a><div class="box">å·¥ä½œä¸€åˆ‡é †åˆ©ï½ ğŸŒˆ<br><a class="ok" href="#p3">pika~</a></div></section>
<section id="pop3" class="layer"><a href="#p3" class="bgclose"></a><div class="box">å¸Œæœ›ä»Šå¤©æ²’æœ‰çªç™¼ç‹€æ³ï¼Œæ˜¯é †å¿ƒå¥½æ—¥å­ï¼ğŸ€<br><a class="ok" href="#p3">pika~</a></div></section>
<section id="pop4" class="layer"><a href="#p3" class="bgclose"></a><div class="box">å‘ˆä¸ŠçœŸå¿ƒçš„è¬åˆ†æ„Ÿè¬ âœ¨â­ï¸â¤ï¸<br><a class="ok" href="#p3">pika~</a></div></section>

<!-- share modal -->
<div class="shareLayer" id="shareLayer">
  <div class="shareCard">
    <h3 style="margin:0 0 6px 0;">åˆ†äº«é€™å¼µå¡ç‰‡</h3>
    <div id="qr" class="qr"></div>
    <div class="row">
      <button class="btn" id="copyUrl">è¤‡è£½ç¶²å€</button>
      <button class="btn alt" id="closeShare">é—œé–‰</button>
    </div>
    <div class="copyNote" id="copyNote"></div>
  </div>
</div>

<script>
(function(){
  const pages=[...document.querySelectorAll('.page')];
  let idx=0;
  const prev=document.getElementById('btnPrev'), next=document.getElementById('btnNext');
  function show(i){
    pages[idx].classList.remove('active');
    idx=Math.max(0,Math.min(pages.length-1,i));
    pages[idx].classList.add('active');
    prev.disabled = (idx===0);
    next.textContent=(idx===pages.length-1)?'å®Œæˆ':'ä¸‹ä¸€é ';
    if(idx===0 && !introEnded){ next.disabled=true; } else { next.disabled=false; }
  }
  prev.onclick=()=>show(idx-1);
  next.onclick=()=>{ if(idx===pages.length-1){ return; } show(idx+1); };
  show(0);

  /* p1 */
  const vIntro=document.getElementById('vIntro');
  const playIntro=document.getElementById('playIntro');
  let introEnded=false;
  function startIntro(){
    vIntro.play()
      .then(()=>{ playIntro.classList.add('hide'); })
      .catch((err)=>{ console.warn('play failed', err); alert('ç„¡æ³•æ’­æ”¾å½±ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆç·¨ç¢¼æˆ–ä¾†æº'); });
  }
  playIntro.addEventListener('click', startIntro);
  vIntro.addEventListener('click', startIntro);
  vIntro.addEventListener('pause', ()=>{ if(!vIntro.ended) playIntro.classList.remove('hide'); });
  vIntro.addEventListener('ended', ()=>{ introEnded=true; next.disabled=false; });

  /* p2 */
  const vAscii=document.getElementById('vAscii');
  const p2wrap=document.getElementById('p2wrap');
  function activateAscii(){
    try{ vAscii.play().catch(()=>{});}catch(e){}
    setTimeout(()=>sampleBg(vAscii).then(c=>{ if(c) p2wrap.style.background=c; }), 60);
  }
  // ç•¶é é¢åˆ‡æ›åˆ° p2 æ™‚è§¸ç™¼æ’­æ”¾ï¼ˆé¿å…è‡ªå‹•æ’­æ”¾é™åˆ¶ï¼‰
  const obs = new MutationObserver(()=>{
    if (pages[1].classList.contains('active')) activateAscii();
    if (pages[3].classList.contains('active')) { try{ vFinale.play().catch(()=>{});}catch(e){} }
  });
  obs.observe(document.querySelector('.pages'),{subtree:true,attributes:true,attributeFilter:['class']});

  function sampleBg(video){
    try{
      if(!video.videoWidth) return null;
      const w=32,h=Math.max(1,Math.round(32*video.videoHeight/video.videoWidth));
      const c=document.createElement('canvas'); const ctx=c.getContext('2d',{willReadFrequently:true});
      c.width=w;c.height=h; ctx.drawImage(video,0,0,w,h);
      const d=ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,n=0;
      for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++;}
      r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
      return `rgb(${r},${g},${b})`;
    }catch(e){ return null; }
  }

  /* p4 finale */
  const vFinale=document.getElementById('vFinale');
  const finalMsg=document.getElementById('finalMsg');
  vFinale.addEventListener('ended', ()=>{ finalMsg.style.display='grid'; });

  document.getElementById('btnReplay').onclick=()=>{
    finalMsg.style.display='none'; vFinale.pause(); vFinale.currentTime=0;
    vAscii.pause(); vAscii.currentTime=0;
    vIntro.pause(); vIntro.currentTime=0; playIntro.classList.remove('hide'); introEnded=false; show(0);
  };

  /* share */
  const shareLayer=document.getElementById('shareLayer');
  document.getElementById('btnShare').onclick=()=>{ shareLayer.classList.add('show'); buildQR(); };
  document.getElementById('closeShare').onclick=()=>{ shareLayer.classList.remove('show'); };
  document.getElementById('copyUrl').onclick=async ()=>{
    const url=location.href.split('#')[0];
    try{ await navigator.clipboard.writeText(url); document.getElementById('copyNote').textContent='å·²è¤‡è£½ç¶²å€ âœ”'; }
    catch(e){ document.getElementById('copyNote').textContent=url; }
  };
  function buildQR(){
    const box=document.getElementById('qr'); box.innerHTML='';
    if(window.QRCode){ new QRCode(box, {text: location.href.split('#')[0], width:220, height:220}); }
    else { box.textContent = location.href.split('#')[0]; }
  }
})();
</script>
</body>
</html>
